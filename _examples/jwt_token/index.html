<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="utf-8">
        <title></title>
        <style>
            input[type="text"] { width: 300px; }
            .muted {color: #CCCCCC; font-size: 10px;}
            .hidden {display: none;}
            #form {margin-top: 10px;}
        </style>
        <script type="text/javascript" src="http://localhost:2000/centrifuge.js"></script>
        <script type="text/javascript">
            // helper functions to work with escaping html.
            const tagsToReplace = {'&': '&amp;', '<': '&lt;', '>': '&gt;'};
            function replaceTag(tag) {return tagsToReplace[tag] || tag;}
            function safeTagsReplace(str) {return str.replace(/[&<>]/g, replaceTag);}

            const channel = "chat";
            let loggedIn = false;

            async function getToken() {
                if (!loggedIn) {
                    return "";
                }
                const res = await fetch('http://localhost:8000/token');
                if (!res.ok) {
                    if (res.status === 403) {
                        // Return special error to not proceed with token refreshes, client will be disconnected.
                        throw new Centrifuge.UnauthorizedError();
                    }
                    // Any other error thrown will result into token refresh re-attempts.
                    throw new Error(`Unexpected status code ${res.status}`);
                }
                const data = await res.json();
                return data.token;
            }

            window.addEventListener('load', function() {
                const centrifuge = new Centrifuge('ws://localhost:8000/connection/websocket', {
                    getToken: getToken
                });

                const input = document.getElementById("input");
                const container = document.getElementById('messages');
                const form = document.getElementById('form');
                const loginButton = document.getElementById('login');
                const logoutButton = document.getElementById('logout');

                centrifuge.on('connecting', function(ctx){
                    drawText('Connecting: ' + ctx.reason);
                    input.setAttribute('disabled', 'true');
                });

                centrifuge.on('disconnected', function(ctx){
                    drawText('Disconnected: ' + ctx.reason);
                    input.setAttribute('disabled', 'true');
                });

                // bind listeners on centrifuge object instance events.
                centrifuge.on('connected', function(ctx){
                    drawText('Connected with client ID ' + ctx.client + ', over ' + ctx.transport);
                    input.removeAttribute('disabled');
                });

                const sub = centrifuge.newSubscription(channel);
                sub.on('publication', handlePublication)
                    .on("subscribed", handleSubscribed)
                    .on("error", handleSubscriptionError);

                centrifuge.connect();

                function handleSubscribed(ctx) {
                    drawText('Subscribed on channel ' + ctx.channel);
                }

                function handleSubscriptionError(err) {
                    drawText('Subscription error in channel ' + err.channel + ': ' + err.message);
                }

                function handlePublication(ctx) {
                    let clientID;
                    if (ctx.info){
                        clientID = ctx.info.client;
                    } else {
                        clientID = null;
                    }
                    const inputText = ctx.data["input"].toString();
                    const text = safeTagsReplace(inputText) + ' <span class="muted">from ' + clientID + '</span>';
                    drawText(text);
                }

                function drawText(text) {
                    let e = document.createElement('li');
                    e.innerHTML = [(new Date()).toString(), ' ' + text].join(':');
                    container.insertBefore(e, container.firstChild);
                }

                form.addEventListener('submit', function(event) {
                    event.preventDefault();
                    sub.publish({"input": input.value}).then(function() {
                        // console.log('message accepted by server');
                    }, function(err) {
                        // console.log('error publishing message', err);
                    });
                    input.value = '';
                });

                loginButton.addEventListener('click', function() {
                    loggedIn = true;
                    centrifuge.disconnect();
                    centrifuge.connect();
                    sub.subscribe();
                    loginButton.classList.toggle("hidden");
                    logoutButton.classList.toggle("hidden");
                    form.classList.toggle("hidden");
                });

                logoutButton.addEventListener('click', function() {
                    loggedIn = false;
                    centrifuge.disconnect({resetConnectionToken: true});
                    sub.unsubscribe();
                    centrifuge.connect();
                    loginButton.classList.toggle("hidden");
                    logoutButton.classList.toggle("hidden");
                    form.classList.toggle("hidden");
                });
            });
        </script>
    </head>
    <body>
        <button id="login">Login</button>
        <button id="logout" class="hidden">Logout</button>
        <form id="form" class="hidden">
            <label for="input"></label><input type="text" id="input" autocomplete="off" />
            <input type="submit" id="submit" value="Â»">
        </form>
        <ul id="messages"></ul>
    </body>
</html>
